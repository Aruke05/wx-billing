<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="zh-CN">
<head>
    <meta charset="UTF-8"/>
    <title>账单分析</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css"/>
    <style>
        body { padding: 20px; }
        .chart { width: 100%; height: 380px; margin-top: 10px; }
        .card { margin-bottom: 16px; }
    </style>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/material_blue.css">
</head>
<body>
<div class="container-fluid">
    <h4>支付账单 · 经营分析</h4>

    <!-- 上传 -->
    <div class="card">
        <div class="card-header">上传 Excel（新增数据）</div>
        <div class="card-body">
            <form id="uploadForm">
                <div class="form-row">
                    <div class="col-md-4">
                        <input type="file" name="file" class="form-control-file" required/>
                    </div>
                    <div class="col-md-3">
                        <input type="text" name="uploadedBy" class="form-control" placeholder="上传人（可选）"/>
                    </div>
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-primary btn-block">上传导入</button>
                    </div>
                </div>
            </form>
            <small id="uploadMsg" class="form-text text-muted"></small>
        </div>
    </div>

    <!-- 筛选 -->
    <div class="card">
        <div class="card-header">筛选条件</div>
        <div class="card-body">
            <form id="filterForm" class="form-row">
                <div class="col-md-4">
                    <label>时间区间</label>
                    <input id="rangePicker" class="form-control" placeholder="选择时间区间">
                    <!-- 保留隐藏字段，用于 fetch 时拼接 -->
                    <input type="hidden" id="start">
                    <input type="hidden" id="end">
                </div>
                <div class="col-md-2">
                    <label>金额范围</label>
                    <div class="input-group">
                        <input type="number" step="0.01" class="form-control" id="minAmount" placeholder="最小金额">
                        <input type="number" step="0.01" class="form-control" id="maxAmount" placeholder="最大金额">
                    </div>
                </div>
                <div class="col-md-2">
                    <label>交易对方</label>
                    <input class="form-control" id="counterparty" placeholder="模糊匹配">
                </div>
                <div class="col-md-2">
                    <label>商品</label>
                    <input class="form-control" id="product" placeholder="模糊匹配">
                </div>
                <div class="col-md-2">
                    <label>方向</label>
                    <select class="form-control" id="direction">
                        <option value="">全部</option>
                        <option value="INCOME">收入</option>
                        <option value="EXPENSE">支出</option>
                        <option value="NEUTRAL">不计收支</option>
                    </select>
                </div>
                <div class="col-md-8">
                    <label>&nbsp;</label>
                </div>
                <div class="col-md-2">
                    <label>&nbsp;</label>
                    <button type="button" class="btn btn-success btn-block" onclick="reloadAll()">应用筛选</button>
                </div>
                <div class="col-md-2">
                    <label>&nbsp;</label>
                    <button type="button" class="btn btn-danger btn-block" onclick="deleteByFilter()">删除筛选</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 图表 -->
    <div class="row">
        <div class="col-md-4"><div id="chartWeekday" class="chart"></div></div>
        <div class="col-md-4"><div id="chartBuckets" class="chart"></div></div>
        <div class="col-md-4"><div id="chartHourly" class="chart"></div></div>
    </div>

    <!-- 表格 -->
    <div class="card">
        <div class="card-header">交易明细</div>
        <div class="col-md-2" style="margin-top: 2vh">
            <button class="btn btn-danger btn-sm mb-2" id="deleteSelected">删除所选</button>
        </div>
        <div class="card-body">
            <!-- 统计概览 -->
            <div id="statsBar" class="mb-3">
                <div class="row g-3">
                    <div class="col-md-3 col-6">
                        <div class="stat-card gradient-green">
                            <div class="label">总收入</div>
                            <div class="value" id="stat-income">—</div>
                        </div>
                    </div>
                    <div class="col-md-3 col-6">
                        <div class="stat-card gradient-red">
                            <div class="label">总支出</div>
                            <div class="value" id="stat-expense">—</div>
                        </div>
                    </div>
                    <div class="col-md-3 col-6">
                        <div class="stat-card gradient-blue">
                            <div class="label">净额</div>
                            <div class="value" id="stat-net">—</div>
                        </div>
                    </div>
                    <div class="col-md-3 col-6">
                        <div class="stat-card gradient-gray">
                            <div class="label">收入笔数 / 平均</div>
                            <div class="value"><span id="stat-income-count">0</span> / <span id="stat-income-avg">—</span></div>
                        </div>
                    </div>
                </div>
            </div>

            <table class="table table-sm table-striped" id="tbl">
                <thead>
                <tr>
                    <th><input type="checkbox" id="selectAll"></th>
                    <th>时间</th>
                    <th>对方</th>
                    <th>商品</th>
                    <th>方向</th>
                    <th>金额</th>
                    <th>方式</th>
                    <th>状态</th>
                    <th>平台</th>
                    <th>交易单号</th>
                </tr>
                </thead>

                <tbody></tbody>
            </table>

            <div class="d-flex align-items-center">
                <nav class="mr-3 mb-0">
                    <ul class="pagination mb-0" id="pager"></ul>
                </nav>
                <div class="form-inline">
                    <span class="mr-2" id="pageInfo">第 1 / 1 页</span>
                    <input type="number" min="1" class="form-control form-control-sm mr-2" id="jumpInput" style="width:100px" placeholder="页码">
                    <button class="btn btn-sm btn-outline-primary" id="jumpBtn">跳转</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dayjs/dayjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/zh.js"></script>
<script>
    const startInput = document.getElementById('start');
    const endInput = document.getElementById('end');
    const cpInput = document.getElementById('counterparty');
    const dirInput = document.getElementById('direction');
    const prodInput  = document.getElementById('product');
    function fmt(d) { return dayjs(d).format('YYYY-MM-DD HH:mm:ss'); }

    // 如果已经初始化过，先销毁，避免重复绑定导致不弹出
    if (window.rangePickerFp && typeof window.rangePickerFp.destroy === 'function') {
        try { window.rangePickerFp.destroy(); } catch (e) { /* ignore */ }
    }

    let _syncing = false;
    // 需要时把它改成 true，即可在“未手动改时间”的情况下自动贴近天边界
    const normalizeToDayBounds = true; // true => 左 00:00:00 / 右 23:59:59.999
    let userEditedTime = false;         // 记录用户是否“手动改过时间”

    function formatDate(d) {
        const pad = n => String(n).padStart(2, '0');
        return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }

    window.rangePickerFp = flatpickr('#rangePicker', {
        mode: 'range',
        enableTime: true,
        enableSeconds: true,
        time_24hr: true,
        altInput: true,
        altFormat: 'Y-m-d H:i:S',
        dateFormat: 'Y-m-d H:i:S',
        locale: 'zh',
        defaultHour: 0,
        defaultMinute: 0,
        defaultSeconds: 0,
        allowInput: true,
        clickOpens: true,

        onOpen() {
            // 每次打开日历时，认为还没手动改过时间；一旦用户在面板里改了输入框，就会置 true
            userEditedTime = false;
        },

        onChange(selectedDates, dateStr, instance) {
            if (_syncing) return;

            const $start = document.getElementById('start');
            const $end   = document.getElementById('end');
            if (!$start || !$end) return;

            // 未选满 2 个则清空隐藏字段
            if (selectedDates.length !== 2) {
                $start.value = '';
                $end.value = '';
                return;
            }

            // 拷贝一份，避免直接改动 flatpickr 内部对象
            const s = new Date(selectedDates[0]);
            const e = new Date(selectedDates[1]);

            // 仅当开启规范化，且用户没有手动改过时间时，才贴到天边界
            if (normalizeToDayBounds && !userEditedTime) {
                // 左 00:00:00.000
                s.setHours(6, 0, 0, 0);
                // 右 23:59:59.999
                e.setHours(6, 0, 0, 0);

                // 如需回写到控件，且不触发 onChange（防止递归/卡顿）
                if (+s !== +selectedDates[0] || +e !== +selectedDates[1]) {
                    _syncing = true;
                    instance.setDate([s, e], false);
                    _syncing = false;
                }
            }

            // 同步隐藏字段（优先 dayjs）
            if (typeof dayjs === 'function') {
                $start.value = dayjs(s).format('YYYY-MM-DD HH:mm:ss');
                $end.value   = dayjs(e).format('YYYY-MM-DD HH:mm:ss');
            } else {
                $start.value = formatDate(s);
                $end.value   = formatDate(e);
            }
        },

        onReady(selectedDates, dateStr, instance) {
            try {
                const container = instance && instance.calendarContainer;
                if (!container) return;

                // 监听“时间输入框”变化——只要用户碰过时/分/秒，就认为是手动编辑过时间
                const timeBox = container.querySelector('.flatpickr-time');
                if (timeBox) {
                    // flatpickr 里这些输入都有 .flatpickr-hour / .flatpickr-minute / .flatpickr-second
                    ['input', 'change'].forEach(ev => {
                        timeBox.addEventListener(ev, () => { userEditedTime = true; }, { passive: true });
                    });
                }

                // 已有则不重复加按钮
                if (!container.querySelector('.flatpickr-clear')) {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.textContent = '清空';
                    btn.className = 'flatpickr-clear btn btn-sm btn-light';
                    btn.style.marginLeft = '8px';

                    btn.onclick = function () {
                        instance.setDate([], true);

                        const $start = document.getElementById('start');
                        const $end   = document.getElementById('end');
                        if ($start) $start.value = '';
                        if ($end)   $end.value   = '';

                        // 兜底：强制同步输入框显示（不改值，只触发刷新）
                        if (instance._input) {
                            instance._input.dispatchEvent(new Event('input', { bubbles: true }));
                            instance._input.dispatchEvent(new Event('change', { bubbles: true }));
                        }

                        requestAnimationFrame(() => {
                            instance.close();
                        });
                    };


                    const fpFooter =
                        container.querySelector('.flatpickr-footer') ||
                        container.querySelector('.flatpickr-time') ||
                        container;
                    fpFooter.appendChild(btn);
                }
            } catch (e) {
                console.error('flatpickr onReady error:', e);
            }
        }
    });


    // 默认给一个近7天区间
    // const now = dayjs();
    // const last7 = now.subtract(6, 'day').startOf('day');
    // document.getElementById('start').value = fmt(last7);
    // document.getElementById('end').value = fmt(now.endOf('day'));
    // 上传
    document.getElementById('uploadForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const form = e.target;
        const fd = new FormData(form);
        const res = await fetch('/api/import/wechat', { method: 'POST', body: fd });
        const data = await res.json();
        document.getElementById('uploadMsg').innerText =
            `批次 #${data.batchId} 导入成功：总行=${data.recordCount}，新增=${data.insertedCount}，重复=${data.duplicatedCount}。` +
            (data.periodStart ? ` 覆盖：${data.periodStart} ~ ${data.periodEnd}` : '');
        reloadAll();
    });

    // 英文枚举 -> 中文展示
    const DIRECTION_CN = { INCOME: '收入', EXPENSE: '支出', NEUTRAL: '中性交易' };
    const CHANNEL_CN = { WECHAT: '微信', ALIPAY: '支付宝'};

    // 表格分页
    let page = 1;
    let size = 20;  // 每页大小，可调
    let total = 0;
    let totalPages = 1;

    async function loadTable(append=false) {
        const params = new URLSearchParams({
            page, size,
            start: startInput.value,
            end: endInput.value,
            counterparty: cpInput.value,
            direction: dirInput.value,
            product: prodInput.value,
            minAmount: document.getElementById('minAmount').value,
            maxAmount: document.getElementById('maxAmount').value
        });

        const res = await fetch('/api/transactions?' + params.toString());
        const data = await res.json();

        total = data.total || 0;
        totalPages = Math.max(1, Math.ceil(total / data.size));
        document.getElementById('pageInfo').innerText = `第 ${data.current} / ${totalPages} 页`;

        const tbody = document.querySelector('#tbl tbody');
        if (!append) tbody.innerHTML = '';

        (data.records || []).forEach(r => {
            const tr = document.createElement('tr');
            const dirCn = DIRECTION_CN[r.direction] || r.direction || '';
            const channelCN = CHANNEL_CN[r.channelType] || r.channelType || '';
            tr.innerHTML = `
      <tr>
        <td><input type="checkbox" class="row-check" value="${r.orderId}"></td>
        <td>${ dayjs(r.tradeTime).format('YYYY-MM-DD HH:mm:ss') }</td>
        <td>${r.counterparty||''}</td>
        <td>${r.product||''}</td>
        <td>${dirCn}</td>
        <td>${r.amount}</td>
        <td>${r.payMethod||''}</td>
        <td>${r.status||''}</td>
        <td>${channelCN}</td>
        <td>${r.orderId}</td>
      </tr>
    `;
            tbody.appendChild(tr);
        });

        // === 新增：统计本次 records 并更新统计卡片 ===
        if (!append) {
            calcTotalsFromApi();
        }

        renderPager();
    }


    // 渲染分页条
    function renderPager() {
        const pager = document.getElementById('pager');
        pager.innerHTML = '';

        const makeItem = (label, targetPage, disabled=false, active=false) => {
            const li = document.createElement('li');
            li.className = `page-item ${disabled ? 'disabled':''} ${active ? 'active':''}`;
            const a = document.createElement('a');
            a.className = 'page-link';
            a.href = 'javascript:void(0)';
            a.textContent = label;
            a.onclick = () => {
                if (disabled || active) return;
                page = targetPage;
                loadTable(false);
            };
            li.appendChild(a);
            return li;
        };

        // 上一页
        pager.appendChild(makeItem('«', Math.max(1, page-1), page<=1));

        // 页码（窗口化显示）
        const windowSize = 5;
        const start = Math.max(1, page - Math.floor(windowSize/2));
        const end = Math.min(totalPages, start + windowSize - 1);
        const realStart = Math.max(1, end - windowSize + 1);

        for (let p = realStart; p <= end; p++) {
            pager.appendChild(makeItem(String(p), p, false, p===page));
        }

        // 下一页
        pager.appendChild(makeItem('»', Math.min(totalPages, page+1), page>=totalPages));
    }

    // 跳转页
    document.getElementById('jumpBtn').onclick = () => {
        const v = parseInt(document.getElementById('jumpInput').value, 10);
        if (!isNaN(v) && v >= 1 && v <= totalPages) {
            page = v;
            loadTable(false);
        } else {
            alert('请输入 1 到 ' + totalPages + ' 之间的页码');
        }
    };
    // 图表
    const c1 = echarts.init(document.getElementById('chartWeekday'));
    const c2 = echarts.init(document.getElementById('chartBuckets'));
    const c3 = echarts.init(document.getElementById('chartHourly'));

    async function loadCharts() {
        function round2(n) {
            const v = Number(n || 0);
            return Math.round(v * 100) / 100; // 保持数值类型，四舍五入到两位
        }

        const base =
            `start=${encodeURIComponent(startInput.value)}`
            + `&end=${encodeURIComponent(endInput.value)}`
            + `&counterparty=${encodeURIComponent(cpInput.value)}`
            + `&direction=${encodeURIComponent(dirInput.value)}`
            + `&minAmount=${encodeURIComponent(document.getElementById('minAmount').value)}`
            + `&maxAmount=${encodeURIComponent(document.getElementById('maxAmount').value)}`
            + `&product=${encodeURIComponent(prodInput.value)}`;
        let res = await fetch('/api/analytics/weekday?' + base);
        let wk = await res.json();
        const wkMap = {1:'周一',2:'周二',3:'周三',4:'周四',5:'周五',6:'周六',7:'周日'};
        const wkX = (Object.keys(wkMap)).map(k=>wkMap[k]);
        const wkY = [1,2,3,4,5,6,7].map(i=>{
            const found = wk.find(x=>x.weekday===i);
            return round2(found ? found.total : 0);  // ★ Y 数据两位
        });
        c1.setOption({
            title: {text:'星期分布(总收入)'},
            tooltip: { trigger:'axis', valueFormatter: v => round2(v).toFixed(2) }, // ★ tooltip 两位
            xAxis: {type:'category', data: wkX, axisLabel: { interval: 0, rotate: 30 }},
            yAxis: {
                type: 'value',
                axisLabel: { formatter: value => round2(value).toFixed(2) } // ★ 坐标轴显示两位
            },
            series: [{ type:'bar', data: wkY }]
        });

        // 时段
        res = await fetch('/api/analytics/time-buckets?' + base);
        const tb = await res.json();
        const order = ['早晨(6-9)','上午(9-11)','中午(11-14)','下午(14-18)','傍晚(18-21)','晚上(21-1)','凌晨(1-6)'];
        c2.setOption({
            title: {text:'时段分布(日平均收入)'},
            tooltip: { trigger:'axis', valueFormatter: v => round2(v).toFixed(2) },  // ★
            xAxis: { type: 'category', data: order, axisLabel: { interval: 0, rotate: 30 } },
            yAxis: {
                type: 'value',
                axisLabel: { formatter: value => round2(value).toFixed(2) } // ★
            },
            series: [{
                type:'bar',
                data: order.map(o => {
                    const f = tb.find(x=>x.bucket===o);
                    return round2(f ? f.total : 0); // ★ Y 数据两位
                })
            }]
        });

        // 小时
        res = await fetch('/api/analytics/hourly?' + base);
        const hh = await res.json();
        const hx = [];
        for (let i = 6; i < 24; i++) hx.push(i);
        for (let i = 0; i < 6; i++) hx.push(i);
        c3.setOption({
            title: {text:'小时分布(日平均收入)'},
            tooltip: { trigger:'axis', valueFormatter: v => round2(v).toFixed(2) },  // ★
            xAxis: { type:'category', data: hx, axisLabel: { interval: 0, rotate: 30 }},
            yAxis: {
                type: 'value',
                axisLabel: { formatter: value => round2(value).toFixed(2) } // ★
            },
            series: [{
                type:'line',
                data: hx.map(h=>{
                    const f = hh.find(x=>x.hour===h);
                    return round2(f ? f.total : 0); // ★ Y 数据两位
                })
            }]
        });
    }

    //删除相关功能
    //删除所选
    document.getElementById('deleteSelected').onclick = async function() {
        const checked = Array.from(document.querySelectorAll('.row-check:checked')).map(chk => chk.value);
        if (!checked.length) { alert('请先选择要删除的行'); return; }
        if (!confirm('确定要删除选中的' + checked.length + '条数据吗？')) return;
        const res = await fetch('/api/transactions/delete', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ orderIds: checked })
        });
        const data = await res.json();
        alert('删除成功：' + data.deleted + ' 条');
        reloadAll();
    };
    //全选
    document.getElementById('selectAll').onclick = function() {
        const all = document.querySelectorAll('.row-check');
        for (const c of all) c.checked = this.checked;
    };
    //删除筛选
    async function deleteByFilter() {
        if (!confirm('确定要删除当前筛选下的所有数据吗？')) return;

        // 这里加上 res =
        const res = await fetch('/api/transactions/delete-by-filter', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                start: startInput.value,
                end: endInput.value,
                counterparty: cpInput.value,
                direction: dirInput.value,
                product: prodInput.value,
                minAmount: document.getElementById('minAmount').value,
                maxAmount: document.getElementById('maxAmount').value
                // 其他字段
            })
        });

        const data = await res.json();
        alert('删除成功：' + data.deleted + ' 条');
        reloadAll();
    }

    // ===== 统计逻辑 =====

    // 全局累计（支持 append=true 时的追加统计）
    let totals = { income: 0, expense: 0, incomeCount: 0, expenseCount: 0 };

    /**
     * 判断是否为“收入方向”
     * 根据你的后端枚举自行调整关键词（已兼容常见中英文/别名）
     */
    function isIncome(direction) {
        const d = (direction || '').toString().toUpperCase();
        return [
            'IN', 'INCOME', 'RECEIVE', 'RECEIPT',
            'SELL', 'SELL_OUT',     // 如果你的业务“卖出”为入账
            '入', '收入', '收款', '卖出'
        ].some(k => d.includes(k));
    }

    /**
     * 判断是否为“支出方向”
     */
    function isExpense(direction) {
        const d = (direction || '').toString().toUpperCase();
        return [
            'OUT', 'OUTCOME', 'PAY', 'PURCHASE', 'BUY',
            '支出', '付款', '买入'
        ].some(k => d.includes(k));
    }

    /** 货币格式（默认 CNY，如有需要改 'CNY' 为你的币种） */
    const fmtMoney = (n) => new Intl.NumberFormat('zh-CN', {
        style: 'currency',
        currency: 'CNY',
        maximumFractionDigits: 2
    }).format(n || 0);

    /** 计算本次 records 的合计；append=true 则在已有 totals 上继续累加 */
    async function calcTotalsFromApi() {
        const params = new URLSearchParams({
            // 统计维度与列表过滤一致，但忽略分页
            start: startInput.value,
            end: endInput.value,
            counterparty: cpInput.value,
            direction: dirInput.value,
            product: prodInput.value,
            minAmount: document.getElementById('minAmount').value,
            maxAmount: document.getElementById('maxAmount').value
        });

        const res = await fetch('/api/transactions/summary?' + params.toString(), { method: 'GET' });
        if (!res.ok) {
            console.error('fetch summary failed', res.status);
            return;
        }
        const s = await res.json(); // 期望后端返回 { income, expense, net, incomeCount }
        totals = {
            income: Number(s.income) || 0,
            expense: Number(s.expense) || 0,
            incomeCount: Number(s.incomeCount) || 0,
            expenseCount: Number(s.expenseCount) || 0
        };
        updateStatsUI();
    }

    /** 更新 UI 展示 */
    function updateStatsUI() {
        const net = totals.income - totals.expense;
        const avgIncome = totals.incomeCount ? totals.income / totals.incomeCount : 0;

        const $income = document.getElementById('stat-income');
        const $expense = document.getElementById('stat-expense');
        const $net = document.getElementById('stat-net');
        const $incomeCount = document.getElementById('stat-income-count');
        const $incomeAvg = document.getElementById('stat-income-avg');

        if (!$income || !$expense || !$net) return; // 统计区不存在时跳过

        $income.innerText = fmtMoney(totals.income);
        $expense.innerText = fmtMoney(totals.expense);
        $net.innerText = fmtMoney(net);
        $incomeCount.innerText = totals.incomeCount;
        $incomeAvg.innerText = fmtMoney(avgIncome);

        // 净额颜色提示
        $net.classList.remove('text-success', 'text-danger');
        if (net > 0) $net.classList.add('text-success');
        else if (net < 0) $net.classList.add('text-danger');
    }

    function reloadAll() { page = 1; loadTable(false); loadCharts();updateStatsUI(); }
    // 初次加载
    reloadAll();
</script>
</body>
</html>
<style>
    /* 美化统计卡片 */
    .stat-card{
        background: var(--bg, #f8f9fa);
        border-radius: 0.9rem;
        padding: 12px 14px;
        box-shadow: 0 4px 16px rgba(0,0,0,.05);
        border: 1px solid rgba(0,0,0,.05);
    }
    .stat-card .label{
        font-size:.85rem;
        color:#6c757d;
        letter-spacing:.02em;
    }
    .stat-card .value{
        font-size:1.25rem;
        font-weight:700;
        line-height:1.3;
    }
    .gradient-green{ --bg: linear-gradient(180deg,#e8fff1, #f8fff9); }
    .gradient-red{   --bg: linear-gradient(180deg,#fff0f0, #fff8f8); }
    .gradient-blue{  --bg: linear-gradient(180deg,#eef6ff, #f7fbff); }
    .gradient-gray{  --bg: linear-gradient(180deg,#f6f6f6, #fcfcfc); }

    /* 统计条吸顶（可选） */
    #statsBar{
        position: sticky;
        top: 0;
        z-index: 100;
        backdrop-filter: saturate(120%) blur(4px);
    }

    /* 暗色模式优化（可选） */
    @media (prefers-color-scheme: dark){
        .stat-card{ border-color: rgba(255,255,255,.08); box-shadow: inset 0 1px 0 rgba(255,255,255,.04), 0 2px 12px rgba(0,0,0,.25); }
        .stat-card .label{ color:#b8c1cc; }
    }

</style>
