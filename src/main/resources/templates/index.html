<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="zh-CN">
<head>
    <meta charset="UTF-8"/>
    <title>微信账单·经营分析</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css"/>
    <style>
        body { padding: 20px; }
        .chart { width: 100%; height: 380px; margin-top: 10px; }
        .card { margin-bottom: 16px; }
    </style>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/material_blue.css">
</head>
<body>
<div class="container-fluid">
    <h4>微信支付账单 · 经营分析</h4>

    <!-- 上传 -->
    <div class="card">
        <div class="card-header">上传 Excel（新增数据）</div>
        <div class="card-body">
            <form id="uploadForm">
                <div class="form-row">
                    <div class="col-md-4">
                        <input type="file" name="file" class="form-control-file" required/>
                    </div>
                    <div class="col-md-3">
                        <input type="text" name="uploadedBy" class="form-control" placeholder="上传人（可选）"/>
                    </div>
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-primary btn-block">上传导入</button>
                    </div>
                </div>
            </form>
            <small id="uploadMsg" class="form-text text-muted"></small>
        </div>
    </div>

    <!-- 筛选 -->
    <div class="card">
        <div class="card-header">筛选条件</div>
        <div class="card-body">
            <form id="filterForm" class="form-row">
                <div class="col-md-4">
                    <label>时间区间</label>
                    <input id="rangePicker" class="form-control" placeholder="选择时间区间">
                    <!-- 保留隐藏字段，用于 fetch 时拼接 -->
                    <input type="hidden" id="start">
                    <input type="hidden" id="end">
                </div>
                <div class="col-md-2">
                    <label>金额范围</label>
                    <div class="input-group">
                        <input type="number" step="0.01" class="form-control" id="minAmount" placeholder="最小金额">
                        <input type="number" step="0.01" class="form-control" id="maxAmount" placeholder="最大金额">
                    </div>
                </div>
                <div class="col-md-2">
                    <label>交易对方</label>
                    <input class="form-control" id="counterparty" placeholder="模糊匹配">
                </div>
                <div class="col-md-1">
                    <label>方向</label>
                    <select class="form-control" id="direction">
                        <option value="">全部</option>
                        <option value="INCOME">收入</option>
                        <option value="EXPENSE">支出</option>
                        <option value="NEUTRAL">不计收支</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label>&nbsp;</label>
                    <button type="button" class="btn btn-success btn-block" onclick="reloadAll()">应用筛选</button>
                </div>
                <div class="col-md-1">
                    <label>&nbsp;</label>
                    <button type="button" class="btn btn-danger btn-block" onclick="deleteByFilter()">删除筛选</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 图表 -->
    <div class="row">
        <div class="col-md-4"><div id="chartWeekday" class="chart"></div></div>
        <div class="col-md-4"><div id="chartBuckets" class="chart"></div></div>
        <div class="col-md-4"><div id="chartHourly" class="chart"></div></div>
    </div>

    <!-- 表格 -->
    <div class="card">
        <div class="card-header">交易明细</div>
        <div class="col-md-2" style="margin-top: 2vh">
            <button class="btn btn-danger btn-sm mb-2" id="deleteSelected">删除所选</button>
        </div>
        <div class="card-body">
            <table class="table table-sm table-striped" id="tbl">
                <thead>
                <tr>
                    <th><input type="checkbox" id="selectAll"></th>
                    <th>时间</th>
                    <th>对方</th>
                    <th>商品</th>
                    <th>方向</th>
                    <th>金额</th>
                    <th>方式</th>
                    <th>状态</th>
                    <th>交易单号</th>
                </tr>
                </thead>

                <tbody></tbody>
            </table>

            <div class="d-flex align-items-center">
                <nav class="mr-3 mb-0">
                    <ul class="pagination mb-0" id="pager"></ul>
                </nav>
                <div class="form-inline">
                    <span class="mr-2" id="pageInfo">第 1 / 1 页</span>
                    <input type="number" min="1" class="form-control form-control-sm mr-2" id="jumpInput" style="width:100px" placeholder="页码">
                    <button class="btn btn-sm btn-outline-primary" id="jumpBtn">跳转</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dayjs/dayjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/zh.js"></script>
<script>
    const startInput = document.getElementById('start');
    const endInput = document.getElementById('end');
    const cpInput = document.getElementById('counterparty');
    const dirInput = document.getElementById('direction');
    function fmt(d) { return dayjs(d).format('YYYY-MM-DD HH:mm:ss'); }

    window.rangePickerFp = flatpickr('#rangePicker', {
        mode: 'range',
        enableTime: true,
        enableSeconds: true,
        time_24hr: true,
        altInput: true,
        altFormat: 'Y-m-d H:i:S',
        dateFormat: 'Y-m-d H:i:S',
        locale: 'zh',
        defaultHour: 0,
        defaultMinute: 0,
        defaultSeconds: 0,
        allowInput: true,
        onChange: function(selectedDates) {
            if (selectedDates.length === 2) {
                document.getElementById('start').value = dayjs(selectedDates[0]).format('YYYY-MM-DD HH:mm:ss');
                document.getElementById('end').value   = dayjs(selectedDates[1]).format('YYYY-MM-DD HH:mm:ss');
            }
        },
        onReady: function(selectedDates, dateStr, instance) {
            // 检查是否已经加过按钮
            if (!instance.calendarContainer.querySelector('.flatpickr-clear')) {
                var btn = document.createElement('button');
                btn.type = 'button';
                btn.textContent = '清空';
                btn.className = 'flatpickr-clear btn btn-sm btn-light';
                btn.style.marginLeft = '8px';
                btn.onclick = function(e) {
                    instance.clear(); // 清空flatpickr
                    // 同步清空隐藏字段
                    document.getElementById('start').value = dayjs(selectedDates[0]).format('YYYY-MM-DD HH:mm:ss');
                    document.getElementById('end').value   = dayjs(selectedDates[1]).format('YYYY-MM-DD HH:mm:ss');
                    instance.close(); // 关闭弹窗
                };
                // 加到按钮栏（和确认、现在按钮同级）
                var fpFooter = instance.calendarContainer.querySelector('.flatpickr-footer') ||
                    instance.calendarContainer.querySelector('.flatpickr-time') ||
                    instance.calendarContainer;
                fpFooter.appendChild(btn);
            }
        }
    });


    // 默认给一个近7天区间
    // const now = dayjs();
    // const last7 = now.subtract(6, 'day').startOf('day');
    // document.getElementById('start').value = fmt(last7);
    // document.getElementById('end').value = fmt(now.endOf('day'));
    // 上传
    document.getElementById('uploadForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const form = e.target;
        const fd = new FormData(form);
        const res = await fetch('/api/import/wechat', { method: 'POST', body: fd });
        const data = await res.json();
        document.getElementById('uploadMsg').innerText =
            `批次 #${data.batchId} 导入成功：总行=${data.recordCount}，新增=${data.insertedCount}，重复=${data.duplicatedCount}。` +
            (data.periodStart ? ` 覆盖：${data.periodStart} ~ ${data.periodEnd}` : '');
        reloadAll();
    });

    // 英文枚举 -> 中文展示
    const DIRECTION_CN = { INCOME: '收入', EXPENSE: '支出', NEUTRAL: '中性交易' };

    // 表格分页
    let page = 1;
    let size = 20;  // 每页大小，可调
    let total = 0;
    let totalPages = 1;

    async function loadTable(append=false) {
        const params = new URLSearchParams({
            page, size,
            start: startInput.value,
            end: endInput.value,
            counterparty: cpInput.value,
            direction: dirInput.value,
            minAmount: document.getElementById('minAmount').value,
            maxAmount: document.getElementById('maxAmount').value
        });


        const res = await fetch('/api/transactions?' + params.toString());


        const data = await res.json();

        total = data.total || 0;
        totalPages = Math.max(1, Math.ceil(total / data.size));
        document.getElementById('pageInfo').innerText = `第 ${data.current} / ${totalPages} 页`;

        const tbody = document.querySelector('#tbl tbody');
        if (!append) tbody.innerHTML = '';

        (data.records || []).forEach(r => {
            const tr = document.createElement('tr');
            const dirCn = DIRECTION_CN[r.direction] || r.direction || '';
            tr.innerHTML = `
                <td><input type="checkbox" class="row-check" value="${r.orderId}"></td>
                <td>${r.tradeTime}</td>
                <td>${r.counterparty||''}</td>
                <td>${r.product||''}</td>
                <td>${dirCn}</td>
                <td>${r.amount}</td>
                <td>${r.payMethod||''}</td>
                <td>${r.status||''}</td>
                <td>${r.orderId}</td>
            `;
            tbody.appendChild(tr);
        });


        renderPager();
    }

    // 渲染分页条
    function renderPager() {
        const pager = document.getElementById('pager');
        pager.innerHTML = '';

        const makeItem = (label, targetPage, disabled=false, active=false) => {
            const li = document.createElement('li');
            li.className = `page-item ${disabled ? 'disabled':''} ${active ? 'active':''}`;
            const a = document.createElement('a');
            a.className = 'page-link';
            a.href = 'javascript:void(0)';
            a.textContent = label;
            a.onclick = () => {
                if (disabled || active) return;
                page = targetPage;
                loadTable(false);
            };
            li.appendChild(a);
            return li;
        };

        // 上一页
        pager.appendChild(makeItem('«', Math.max(1, page-1), page<=1));

        // 页码（窗口化显示）
        const windowSize = 5;
        const start = Math.max(1, page - Math.floor(windowSize/2));
        const end = Math.min(totalPages, start + windowSize - 1);
        const realStart = Math.max(1, end - windowSize + 1);

        for (let p = realStart; p <= end; p++) {
            pager.appendChild(makeItem(String(p), p, false, p===page));
        }

        // 下一页
        pager.appendChild(makeItem('»', Math.min(totalPages, page+1), page>=totalPages));
    }

    // 跳转页
    document.getElementById('jumpBtn').onclick = () => {
        const v = parseInt(document.getElementById('jumpInput').value, 10);
        if (!isNaN(v) && v >= 1 && v <= totalPages) {
            page = v;
            loadTable(false);
        } else {
            alert('请输入 1 到 ' + totalPages + ' 之间的页码');
        }
    };
    // 图表
    const c1 = echarts.init(document.getElementById('chartWeekday'));
    const c2 = echarts.init(document.getElementById('chartBuckets'));
    const c3 = echarts.init(document.getElementById('chartHourly'));

    async function loadCharts() {
        const base =
            `start=${encodeURIComponent(startInput.value)}`
            + `&end=${encodeURIComponent(endInput.value)}`
            + `&counterparty=${encodeURIComponent(cpInput.value)}`
            + `&direction=${encodeURIComponent(dirInput.value)}`
            + `&minAmount=${encodeURIComponent(document.getElementById('minAmount').value)}`
            + `&maxAmount=${encodeURIComponent(document.getElementById('maxAmount').value)}`;
        let res = await fetch('/api/analytics/weekday?' + base);
        let wk = await res.json();
        const wkMap = {1:'周一',2:'周二',3:'周三',4:'周四',5:'周五',6:'周六',7:'周日'};
        const wkX = (Object.keys(wkMap)).map(k=>wkMap[k]);
        const wkY = [1,2,3,4,5,6,7].map(i=>{
            const found = wk.find(x=>x.weekday===i);
            return found ? found.total : 0;
        });
        c1.setOption({
            title: {text:'星期分布(收入)'},
            tooltip: {trigger:'axis'},
            xAxis: {type:'category', data: wkX, axisLabel: { interval: 0, rotate: 30 }},
            yAxis: {type:'value'},
            series: [{type:'bar', data: wkY}]
        });

        // 时段
        res = await fetch('/api/analytics/time-buckets?' + base);
        const tb = await res.json();
        const order = ['凌晨(1-4)','早晨(5-7)','上午(8-10)','中午(11-13)','下午(14-17)','傍晚(18-20)','晚上(21-0)'];
        c2.setOption({
            title: {text:'时段分布(收入)'},
            tooltip: {trigger:'axis'},
            xAxis: {
                type: 'category',
                data: order,
                axisLabel: { interval: 0, rotate: 30 }
            },
            yAxis: {type:'value'},
            series: [{type:'bar', data: order.map(o => {
                    const f = tb.find(x=>x.bucket===o);
                    return f ? f.total : 0;
                })}]
        });

        // 小时
        res = await fetch('/api/analytics/hourly?' + base);
        const hh = await res.json();
        const hx = Array.from({length:24}, (_,i)=>i);
        c3.setOption({
            title: {text:'小时分布(收入)'},
            tooltip: {trigger:'axis'},
            xAxis: {type:'category', data: hx, axisLabel: { interval: 0, rotate: 30 }},
            yAxis: {type:'value'},
            series: [{type:'line', data: hx.map(h=>{
                    const f = hh.find(x=>x.hour===h);
                    return f ? f.total : 0;
                })}]
        });
    }

    //删除相关功能
    //删除所选
    document.getElementById('deleteSelected').onclick = async function() {
        const checked = Array.from(document.querySelectorAll('.row-check:checked')).map(chk => chk.value);
        if (!checked.length) { alert('请先选择要删除的行'); return; }
        if (!confirm('确定要删除选中的' + checked.length + '条数据吗？')) return;
        const res = await fetch('/api/transactions/delete', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ orderIds: checked })
        });
        const data = await res.json();
        alert('删除成功：' + data.deleted + ' 条');
        reloadAll();
    };
    //全选
    document.getElementById('selectAll').onclick = function() {
        const all = document.querySelectorAll('.row-check');
        for (const c of all) c.checked = this.checked;
    };
    //删除筛选
    async function deleteByFilter() {
        if (!confirm('确定要删除当前筛选下的所有数据吗？')) return;

        // 这里加上 res =
        const res = await fetch('/api/transactions/delete-by-filter', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                start: startInput.value,
                end: endInput.value,
                counterparty: cpInput.value,
                direction: dirInput.value,
                minAmount: document.getElementById('minAmount').value,
                maxAmount: document.getElementById('maxAmount').value
                // 其他字段
            })
        });

        const data = await res.json();
        alert('删除成功：' + data.deleted + ' 条');
        reloadAll();
    }


    function reloadAll() { page = 1; loadTable(false); loadCharts(); }
    // 初次加载
    reloadAll();
</script>
</body>
</html>
