<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.enu9.bili.mapper.AnalyticsMapper">

    <!-- 星期分布：净收入（收入-支出） -->
    <select id="sumByWeekday" resultType="map">
        SELECT
        weekday,
        SUM(CASE WHEN direction = 'INCOME'  THEN amount ELSE 0 END)
        - SUM(CASE WHEN direction = 'EXPENSE' THEN amount ELSE 0 END) AS total,
        SUM(CASE WHEN direction IN ('INCOME','EXPENSE') THEN 1 ELSE 0 END) AS cnt
        FROM wx_pay_txn
        WHERE trade_time BETWEEN #{start} AND #{end}
        AND direction IN ('INCOME','EXPENSE')
        <if test="counterparty != null and counterparty != ''">
            AND counterparty LIKE CONCAT('%', #{counterparty}, '%')
        </if>
        <if test="direction != null and direction != ''">
            AND direction = #{direction}
        </if>
        GROUP BY weekday
        ORDER BY weekday
    </select>


    <!-- 自定义时段分布：净收入（收入-支出） -->
    <select id="sumByTimeBuckets" resultType="map">
        SELECT
        CASE
        WHEN trade_hour BETWEEN 0  AND 4  THEN '凌晨(1-4)'
        WHEN trade_hour BETWEEN 5  AND 7  THEN '早晨(5-7)'
        WHEN trade_hour BETWEEN 8 AND 10 THEN '上午(8-10)'
        WHEN trade_hour BETWEEN 11 AND 13 THEN '中午(11-13)'
        WHEN trade_hour BETWEEN 14 AND 17 THEN '下午(14-17)'
        WHEN trade_hour BETWEEN 18 AND 20 THEN '傍晚(18-20)'
        WHEN trade_hour IN (21,22,23,0)  THEN '晚上(21-0)'
        END AS bucket,
        SUM(CASE WHEN direction = 'INCOME'  THEN amount ELSE 0 END)
        - SUM(CASE WHEN direction = 'EXPENSE' THEN amount ELSE 0 END) AS total,
        SUM(CASE WHEN direction IN ('INCOME','EXPENSE') THEN 1 ELSE 0 END) AS cnt
        FROM wx_pay_txn
        WHERE trade_time BETWEEN #{start} AND #{end}
        AND direction IN ('INCOME','EXPENSE')
        <if test="counterparty != null and counterparty != ''">
            AND counterparty LIKE CONCAT('%', #{counterparty}, '%')
        </if>
        <if test="direction != null and direction != ''">
            AND direction = #{direction}
        </if>
        GROUP BY bucket
    </select>


    <!-- 小时分布：净收入（收入-支出） -->
    <select id="sumByHour" resultType="map">
        <![CDATA[
    SELECT
        trade_hour AS "hour",
        SUM(CASE WHEN direction = 'INCOME'  THEN amount ELSE 0 END)
          - SUM(CASE WHEN direction = 'EXPENSE' THEN amount ELSE 0 END) AS total,
        SUM(CASE WHEN direction IN ('INCOME','EXPENSE') THEN 1 ELSE 0 END) AS cnt
    FROM wx_pay_txn
    WHERE trade_time BETWEEN #{start} AND #{end}
      AND direction IN ('INCOME','EXPENSE')
  ]]>
        <if test="counterparty != null and counterparty != ''">
            AND counterparty LIKE CONCAT('%', #{counterparty}, '%')
        </if>
        <if test="direction != null and direction != ''">
            AND direction = #{direction}
        </if>
        <![CDATA[
    GROUP BY trade_hour
    ORDER BY trade_hour
  ]]>
    </select>



</mapper>
